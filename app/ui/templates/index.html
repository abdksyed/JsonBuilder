<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema-Aware JSON Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Schema-Aware JSON Extractor</h1>
        
        <div class="max-w-4xl mx-auto">
            <!-- Tab Navigation -->
            <div class="mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8">
                        <button id="manual-tab" class="tab-button active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            Manual Schema
                        </button>
                        <button id="auto-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Auto-Detect
                        </button>
                        <button id="add-schema-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Add Schema
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Manual Schema Tab -->
            <div id="manual-content" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Input Section -->
                    <div class="space-y-4">
                        <div>
                            <label for="text-input" class="block text-sm font-medium text-gray-700 mb-2">
                                Input Text
                            </label>
                            <textarea id="text-input" 
                                    class="w-full h-40 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                    placeholder="Enter the text you want to extract JSON from..."></textarea>
                        </div>
                        
                        <div>
                            <label for="schema-select" class="block text-sm font-medium text-gray-700 mb-2">
                                Select Schema
                            </label>
                            <select id="schema-select" 
                                    class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Loading schemas...</option>
                            </select>
                        </div>
                        
                        <button id="extract-btn" 
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 font-medium">
                            Extract JSON
                        </button>
                    </div>

                    <!-- Output Section -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-medium text-gray-700">
                                Extracted JSON
                            </label>
                            <div id="validation-badge" class="hidden">
                                <span id="valid-badge" class="hidden inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    ‚úÖ Valid
                                </span>
                                <span id="invalid-badge" class="hidden inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    ‚ùå Invalid
                                </span>
                            </div>
                        </div>
                        
                        <!-- Performance Stats for Manual -->
                        <div id="manual-performance-stats" class="hidden bg-gray-50 border border-gray-200 rounded-md p-3">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Performance Metrics</h4>
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                <div>Time: <span id="manual-stat-time">-</span>s</div>
                                <div>Model: <span id="manual-stat-model">-</span></div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <pre id="json-output" 
                                 class="w-full h-40 p-3 bg-gray-50 border border-gray-300 rounded-md font-mono text-sm overflow-auto"></pre>
                            <button id="copy-btn" 
                                    class="hidden absolute top-2 right-2 bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs">
                                Copy
                            </button>
                        </div>
                        
                        <div id="metadata" class="hidden text-sm text-gray-600">
                            <p>Attempts: <span id="attempts-count">-</span></p>
                            <p id="error-message" class="hidden text-red-600"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auto-Detect Tab -->
            <div id="auto-content" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Input Section -->
                    <div class="space-y-4">
                        <div>
                            <label for="auto-text-input" class="block text-sm font-medium text-gray-700 mb-2">
                                Input Text
                            </label>
                            <textarea id="auto-text-input" 
                                    class="w-full h-40 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                    placeholder="Enter text and let AI automatically select the best schema..."></textarea>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-blue-800">
                                        Enhanced Auto-Detection Workflow
                                    </h3>
                                    <div class="mt-2 text-sm text-blue-700">
                                        <p>1. AI selects best schema for your text<br>
                                        2. Review and confirm the selected schema<br>
                                        3. Extract JSON with the confirmed schema</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="selection-method" class="block text-sm font-medium text-gray-700 mb-2">
                                Auto-Selection Method
                            </label>
                            <select id="selection-method" 
                                    class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                <option value="embedding">üöÄ Embedding Similarity (Fast & Efficient)</option>
                                <option value="llm">üß† LLM Analysis (Detailed & Contextual)</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">
                                Embedding: ~1s, ~$0.001 | LLM: ~5s, ~$0.01
                            </p>
                        </div>
                        
                        <button id="auto-select-btn" 
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 font-medium">
                            üéØ Auto-Select Schema
                        </button>
                        
                        <!-- Schema Confirmation Section -->
                        <div id="schema-confirmation" class="hidden bg-yellow-50 border border-yellow-200 rounded-md p-4">
                            <h4 class="text-sm font-medium text-yellow-800 mb-2">Selected Schema:</h4>
                            <div class="space-y-2">
                                <p class="text-sm text-yellow-700"><strong id="selected-title">-</strong></p>
                                <p class="text-xs text-yellow-600" id="selected-summary">-</p>
                                <select id="schema-override" class="w-full text-sm border border-yellow-300 rounded px-2 py-1">
                                    <option value="">Use AI selection or choose different schema...</option>
                                </select>
                            </div>
                            <div class="mt-3 flex space-x-2">
                                <button id="confirm-extract-btn" 
                                        class="flex-1 bg-green-600 text-white py-2 px-3 rounded text-sm hover:bg-green-700">
                                    ‚úÖ Extract with This Schema
                                </button>
                                <button id="cancel-selection-btn" 
                                        class="px-3 py-2 border border-gray-300 text-gray-700 rounded text-sm hover:bg-gray-50">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Output Section -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-medium text-gray-700">
                                Extracted JSON
                            </label>
                            <div id="auto-validation-badge" class="hidden">
                                <span id="auto-valid-badge" class="hidden inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    ‚úÖ Valid
                                </span>
                                <span id="auto-invalid-badge" class="hidden inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    ‚ùå Invalid
                                </span>
                            </div>
                        </div>
                        
                        <!-- Performance Stats -->
                        <div id="performance-stats" class="hidden bg-gray-50 border border-gray-200 rounded-md p-3">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Performance Metrics</h4>
                            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                <div>Time: <span id="stat-time">-</span>s</div>
                                <div>Cost: $<span id="stat-cost">-</span></div>
                                <div>Tokens: <span id="stat-tokens">-</span></div>
                                <div>Model: <span id="stat-model">-</span></div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <pre id="auto-json-output" 
                                 class="w-full h-40 p-3 bg-gray-50 border border-gray-300 rounded-md font-mono text-sm overflow-auto"></pre>
                            <button id="auto-copy-btn" 
                                    class="hidden absolute top-2 right-2 bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs">
                                Copy
                            </button>
                        </div>
                        
                        <div id="auto-metadata" class="hidden text-sm text-gray-600">
                            <p>Attempts: <span id="auto-attempts-count">-</span></p>
                            <p>Schema: <span id="final-schema-name">-</span></p>
                            <p id="auto-error-message" class="hidden text-red-600"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Schema Tab -->
            <div id="add-schema-content" class="tab-content hidden">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-6">Create New Schema</h3>
                        
                        <form id="schema-form" class="space-y-4">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-yellow-800">
                                            AI-Powered Schema Creation
                                        </h3>
                                        <div class="mt-2 text-sm text-yellow-700">
                                            <p>Leave title and summary empty to auto-generate them using AI! Just provide the JSON schema.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="schema-title" class="block text-sm font-medium text-gray-700 mb-2">
                                    Schema Title <span class="text-gray-400">(optional - AI will generate if empty)</span>
                                </label>
                                <input type="text" id="schema-title" 
                                       class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="e.g., Person Information">
                            </div>
                            
                            <div>
                                <label for="schema-summary" class="block text-sm font-medium text-gray-700 mb-2">
                                    Summary <span class="text-gray-400">(optional - AI will generate if empty)</span>
                                </label>
                                <textarea id="schema-summary" 
                                          class="w-full h-20 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 resize-vertical"
                                          placeholder="Brief description of what this schema extracts"></textarea>
                            </div>
                            
                            
                            <div>
                                <label for="schema-json" class="block text-sm font-medium text-gray-700 mb-2">
                                    JSON Schema
                                </label>
                                <textarea id="schema-json" 
                                          class="w-full h-64 p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                          placeholder='Enter your JSON schema here, e.g.:
{
  "type": "object",
  "properties": {
    "name": {"type": "string"},
    "age": {"type": "number"}
  },
  "required": ["name"]
}'
                                          required></textarea>
                                <p class="mt-1 text-sm text-gray-500">Enter a valid JSON Schema (Draft 7)</p>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" id="create-schema-btn"
                                        class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 font-medium">
                                    Create Schema
                                </button>
                                <button type="button" id="validate-schema-btn"
                                        class="px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 font-medium">
                                    Validate
                                </button>
                            </div>
                        </form>
                        
                        <div id="schema-feedback" class="mt-4 hidden">
                            <div id="schema-success" class="hidden p-3 bg-green-100 border border-green-400 text-green-700 rounded-md">
                                <p class="font-medium">‚úÖ Schema created successfully!</p>
                                <p class="text-sm mt-1">ID: <span id="created-schema-id"></span></p>
                            </div>
                            <div id="schema-error" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-md">
                                <p class="font-medium">‚ùå Error</p>
                                <p class="text-sm mt-1" id="schema-error-message"></p>
                            </div>
                            <div id="schema-validation" class="hidden p-3 bg-blue-100 border border-blue-400 text-blue-700 rounded-md">
                                <p class="font-medium">‚úÖ Schema is valid!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Example Schema Templates -->
                    <div class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h4 class="text-md font-medium text-gray-900 mb-4">Example Schema Templates</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button class="schema-template text-left p-3 border border-gray-200 rounded-md hover:bg-gray-50"
                                    data-title="Person Information"
                                    data-summary="Extract person details like name, age, email"
                                    data-schema='{"type": "object", "properties": {"name": {"type": "string"}, "age": {"type": "number"}, "email": {"type": "string", "format": "email"}}, "required": ["name"]}'>
                                <div class="font-medium text-gray-900">Person Information</div>
                                <div class="text-sm text-gray-600">Name, age, email extraction</div>
                            </button>
                            
                            <button class="schema-template text-left p-3 border border-gray-200 rounded-md hover:bg-gray-50"
                                    data-title="Product Information"
                                    data-summary="Extract product details like name, price, description"
                                    data-schema='{"type": "object", "properties": {"name": {"type": "string"}, "price": {"type": "number"}, "description": {"type": "string"}, "category": {"type": "string"}}, "required": ["name", "price"]}'>
                                <div class="font-medium text-gray-900">Product Information</div>
                                <div class="text-sm text-gray-600">Product name, price, description</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.id;
                let contentId;
                
                switch(tabId) {
                    case 'manual-tab':
                        contentId = 'manual-content';
                        break;
                    case 'auto-tab':
                        contentId = 'auto-content';
                        break;
                    case 'add-schema-tab':
                        contentId = 'add-schema-content';
                        break;
                }
                
                // Update tab buttons
                document.querySelectorAll('.tab-button').forEach(b => {
                    b.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    b.classList.add('border-transparent', 'text-gray-500');
                });
                button.classList.add('active', 'border-blue-500', 'text-blue-600');
                button.classList.remove('border-transparent', 'text-gray-500');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(contentId).classList.remove('hidden');
            });
        });

        // Load schemas
        async function loadSchemas() {
            try {
                const response = await axios.get('/schemas');
                const select = document.getElementById('schema-select');
                select.innerHTML = '<option value="">Select a schema...</option>';
                
                response.data.schemas.forEach(schema => {
                    const option = document.createElement('option');
                    option.value = schema.id;
                    option.textContent = `${schema.title} - ${schema.summary}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load schemas:', error);
                document.getElementById('schema-select').innerHTML = '<option value="">Failed to load schemas</option>';
            }
        }

        // Extract JSON
        async function extractJSON() {
            const text = document.getElementById('text-input').value.trim();
            const schemaId = document.getElementById('schema-select').value;
            
            if (!text || !schemaId) {
                alert('Please enter text and select a schema');
                return;
            }
            
            const button = document.getElementById('extract-btn');
            button.disabled = true;
            button.textContent = 'Extracting...';
            
            try {
                const response = await axios.post('/extract', {
                    text: text,
                    schema_id: schemaId
                });
                
                const result = response.data;
                
                // Display JSON
                document.getElementById('json-output').textContent = JSON.stringify(result.data, null, 2);
                
                // Show validation badge
                const validBadge = document.getElementById('valid-badge');
                const invalidBadge = document.getElementById('invalid-badge');
                const badge = document.getElementById('validation-badge');
                
                badge.classList.remove('hidden');
                if (result.valid) {
                    validBadge.classList.remove('hidden');
                    invalidBadge.classList.add('hidden');
                } else {
                    validBadge.classList.add('hidden');
                    invalidBadge.classList.remove('hidden');
                }
                
                // Show metadata
                document.getElementById('attempts-count').textContent = result.attempts;
                const metadata = document.getElementById('metadata');
                metadata.classList.remove('hidden');
                
                const errorMsg = document.getElementById('error-message');
                if (result.error) {
                    errorMsg.textContent = `Error: ${result.error}`;
                    errorMsg.classList.remove('hidden');
                } else {
                    errorMsg.classList.add('hidden');
                }
                
                // Show copy button
                document.getElementById('copy-btn').classList.remove('hidden');
                
                // Show performance stats for manual extraction if available
                if (result.stats) {
                    showManualPerformanceStats(result.stats);
                }
                
            } catch (error) {
                console.error('Extraction failed:', error);
                document.getElementById('json-output').textContent = 'Extraction failed: ' + error.response?.data?.detail || error.message;
            } finally {
                button.disabled = false;
                button.textContent = 'Extract JSON';
            }
        }

        // Copy to clipboard
        function copyToClipboard() {
            const output = document.getElementById('json-output').textContent;
            navigator.clipboard.writeText(output).then(() => {
                const button = document.getElementById('copy-btn');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => button.textContent = originalText, 2000);
            });
        }

        // Schema validation
        function validateSchema() {
            const schemaText = document.getElementById('schema-json').value.trim();
            
            if (!schemaText) {
                showSchemaFeedback('error', 'Please enter a schema');
                return false;
            }
            
            try {
                const schema = JSON.parse(schemaText);
                showSchemaFeedback('validation', 'Schema is valid JSON');
                return true;
            } catch (e) {
                showSchemaFeedback('error', `Invalid JSON: ${e.message}`);
                return false;
            }
        }

        // Global variables for auto-detect workflow
        let selectedSchemaData = null;
        let allSchemas = [];

        // Auto-select schema
        async function autoSelectSchema() {
            const text = document.getElementById('auto-text-input').value.trim();
            const method = document.getElementById('selection-method').value;
            
            if (!text) {
                alert('Please enter text to analyze');
                return;
            }
            
            const button = document.getElementById('auto-select-btn');
            button.disabled = true;
            button.textContent = `üéØ Selecting Schema (${method})...`;
            
            try {
                const response = await axios.post('/select-schema', {
                    text: text,
                    method: method
                });
                
                const result = response.data;
                selectedSchemaData = result;
                
                // Show schema confirmation
                document.getElementById('selected-title').textContent = result.schema_title || result.schema_id;
                document.getElementById('selected-summary').textContent = result.schema_summary || 'No summary available';
                
                // Populate schema override dropdown
                await populateSchemaOverride();
                
                // Show confirmation section
                document.getElementById('schema-confirmation').classList.remove('hidden');
                
                // Show selection stats
                if (result.stats) {
                    const modelName = result.stats.method === 'embedding' ? 'text-embedding-004' : 'gemini-2.5-flash';
                    showPerformanceStats(result.stats, modelName);
                }
                
            } catch (error) {
                console.error('Schema selection failed:', error);
                alert('Schema selection failed: ' + (error.response?.data?.detail || error.message));
            } finally {
                button.disabled = false;
                button.textContent = 'üéØ Auto-Select Schema';
            }
        }

        // Populate schema override dropdown
        async function populateSchemaOverride() {
            try {
                if (allSchemas.length === 0) {
                    const response = await axios.get('/schemas');
                    allSchemas = response.data.schemas;
                }
                
                const select = document.getElementById('schema-override');
                select.innerHTML = '<option value="">Use AI selection or choose different schema...</option>';
                
                allSchemas.forEach(schema => {
                    const option = document.createElement('option');
                    option.value = schema.id;
                    option.textContent = `${schema.title} - ${schema.summary}`;
                    if (schema.id === selectedSchemaData?.schema_id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load schemas for override:', error);
            }
        }

        // Confirm and extract with selected schema
        async function confirmAndExtract() {
            const text = document.getElementById('auto-text-input').value.trim();
            const overrideSelect = document.getElementById('schema-override');
            const schemaId = overrideSelect.value || selectedSchemaData?.schema_id;
            
            if (!text || !schemaId) {
                alert('Please ensure text and schema are selected');
                return;
            }
            
            const button = document.getElementById('confirm-extract-btn');
            button.disabled = true;
            button.textContent = '‚è≥ Extracting...';
            
            try {
                const response = await axios.post('/extract', {
                    text: text,
                    schema_id: schemaId
                });
                
                const result = response.data;
                
                // Display JSON
                document.getElementById('auto-json-output').textContent = JSON.stringify(result.data, null, 2);
                
                // Show validation badge
                const validBadge = document.getElementById('auto-valid-badge');
                const invalidBadge = document.getElementById('auto-invalid-badge');
                const badge = document.getElementById('auto-validation-badge');
                
                badge.classList.remove('hidden');
                if (result.valid) {
                    validBadge.classList.remove('hidden');
                    invalidBadge.classList.add('hidden');
                } else {
                    validBadge.classList.add('hidden');
                    invalidBadge.classList.remove('hidden');
                }
                
                // Show metadata
                document.getElementById('auto-attempts-count').textContent = result.attempts;
                document.getElementById('final-schema-name').textContent = schemaId;
                const metadata = document.getElementById('auto-metadata');
                metadata.classList.remove('hidden');
                
                const errorMsg = document.getElementById('auto-error-message');
                if (result.error) {
                    errorMsg.textContent = `Error: ${result.error}`;
                    errorMsg.classList.remove('hidden');
                } else {
                    errorMsg.classList.add('hidden');
                }
                
                // Show copy button
                document.getElementById('auto-copy-btn').classList.remove('hidden');
                
                // Show performance stats if available
                if (result.stats) {
                    showPerformanceStats(result.stats, result.stats.model || 'gemini-2.5-pro');
                }
                
                // Hide confirmation section
                document.getElementById('schema-confirmation').classList.add('hidden');
                
            } catch (error) {
                console.error('Extraction failed:', error);
                document.getElementById('auto-json-output').textContent = 'Extraction failed: ' + (error.response?.data?.detail || error.message);
            } finally {
                button.disabled = false;
                button.textContent = '‚úÖ Extract with This Schema';
            }
        }

        // Cancel schema selection
        function cancelSelection() {
            document.getElementById('schema-confirmation').classList.add('hidden');
            selectedSchemaData = null;
            document.getElementById('performance-stats').classList.add('hidden');
        }

        // Show performance statistics
        function showPerformanceStats(stats, model) {
            document.getElementById('stat-time').textContent = (stats.duration || 0).toFixed(2);
            document.getElementById('stat-cost').textContent = (stats.total_cost || 0).toFixed(6);
            document.getElementById('stat-tokens').textContent = stats.total_tokens || 0;
            document.getElementById('stat-model').textContent = model || 'Unknown';
            document.getElementById('performance-stats').classList.remove('hidden');
        }
        
        // Show manual performance statistics
        function showManualPerformanceStats(stats) {
            document.getElementById('manual-stat-time').textContent = (stats.duration || 0).toFixed(2);
            document.getElementById('manual-stat-model').textContent = stats.model || 'Unknown';
            document.getElementById('manual-performance-stats').classList.remove('hidden');
        }

        // Auto copy to clipboard
        function autoCopyToClipboard() {
            const output = document.getElementById('auto-json-output').textContent;
            navigator.clipboard.writeText(output).then(() => {
                const button = document.getElementById('auto-copy-btn');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => button.textContent = originalText, 2000);
            });
        }

        // Create schema
        async function createSchema(event) {
            event.preventDefault();
            
            const title = document.getElementById('schema-title').value.trim();
            const summary = document.getElementById('schema-summary').value.trim();
            const schemaText = document.getElementById('schema-json').value.trim();
            
            if (!schemaText) {
                showSchemaFeedback('error', 'Please provide the JSON schema');
                return;
            }
            
            let schemaData;
            try {
                schemaData = JSON.parse(schemaText);
            } catch (e) {
                showSchemaFeedback('error', `Invalid JSON: ${e.message}`);
                return;
            }
            
            const button = document.getElementById('create-schema-btn');
            button.disabled = true;
            button.textContent = 'Creating...';
            
            try {
                const payload = { schema_data: schemaData };
                if (title) payload.title = title;
                if (summary) payload.summary = summary;
                
                const response = await axios.post('/schemas', payload);
                
                const result = response.data;
                document.getElementById('created-schema-id').textContent = result.id;
                showSchemaFeedback('success', 'Schema created successfully');
                
                // Clear form
                document.getElementById('schema-form').reset();
                
                // Reload schemas in the manual tab
                loadSchemas();
                
            } catch (error) {
                console.error('Schema creation failed:', error);
                const errorMsg = error.response?.data?.detail || error.message;
                showSchemaFeedback('error', errorMsg);
            } finally {
                button.disabled = false;
                button.textContent = 'Create Schema';
            }
        }

        // Show schema feedback
        function showSchemaFeedback(type, message) {
            const feedbackContainer = document.getElementById('schema-feedback');
            const successDiv = document.getElementById('schema-success');
            const errorDiv = document.getElementById('schema-error');
            const validationDiv = document.getElementById('schema-validation');
            
            // Hide all feedback types
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            validationDiv.classList.add('hidden');
            
            // Show the appropriate feedback
            feedbackContainer.classList.remove('hidden');
            
            if (type === 'success') {
                successDiv.classList.remove('hidden');
            } else if (type === 'error') {
                document.getElementById('schema-error-message').textContent = message;
                errorDiv.classList.remove('hidden');
            } else if (type === 'validation') {
                validationDiv.classList.remove('hidden');
            }
        }

        // Load schema template
        function loadTemplate(button) {
            const title = button.dataset.title;
            const summary = button.dataset.summary;
            const schema = button.dataset.schema;
            
            document.getElementById('schema-title').value = title;
            document.getElementById('schema-summary').value = summary;
            document.getElementById('schema-json').value = JSON.stringify(JSON.parse(schema), null, 2);
            
            // Hide feedback
            document.getElementById('schema-feedback').classList.add('hidden');
        }

        // Event listeners
        document.getElementById('extract-btn').addEventListener('click', extractJSON);
        document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
        document.getElementById('auto-select-btn').addEventListener('click', autoSelectSchema);
        document.getElementById('confirm-extract-btn').addEventListener('click', confirmAndExtract);
        document.getElementById('cancel-selection-btn').addEventListener('click', cancelSelection);
        document.getElementById('auto-copy-btn').addEventListener('click', autoCopyToClipboard);
        document.getElementById('schema-form').addEventListener('submit', createSchema);
        document.getElementById('validate-schema-btn').addEventListener('click', validateSchema);
        
        // Template button listeners
        document.querySelectorAll('.schema-template').forEach(button => {
            button.addEventListener('click', () => loadTemplate(button));
        });

        // Initialize
        loadSchemas();
    </script>
</body>
</html>